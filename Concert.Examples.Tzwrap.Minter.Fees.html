<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<title>Fees</title>
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Library Fees</h1>

<div class="code">
</div>

<div class="doc">
<a name="lab128"></a><h1 class="section">Fees part of the Minter Contract</h1>
 This file contains the functionality for withdrawal of fees that were distributed by wrapping and unwrapping.
    The fees distributed is defined by the percentage set by the admin quorum. The withdrawal can be done either for a single token/xtz or for all of the tokens or xtz's
    This file together with Fees_Lib and Fees_Interface contains the full logic and functionality of the Fees part of the Minter Contract
    The file this file has been translated from can be found here:
    https://github.com/bender-labs/wrap-tz-contracts/blob/1655949e61b05a1c25cc00dcb8c1da9d91799f31/ligo/minter/fees.mligo

</div>
<div class="code">
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Storage</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Blockchain</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="keyword">Types</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Storage</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Fees_Lib</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Fees_Interface</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Serializable</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Monads</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Utils</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">RecordUpdate</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">FA2Interface</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Execution</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Containers</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">FA2Interface_Wrap</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Extras</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">List</span>.<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">ListNotations</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">ZArith</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">ContractCommon</span>.<br/>

<br/>
<span class="id" title="keyword">Section</span> <span class="id" title="var">Fees</span>.<br/>
<span class="id" title="keyword">Set</span> <span class="id" title="var">Nonrecursive</span> <span class="id" title="var">Elimination</span> <span class="id" title="var">Schemes</span>.<br/>
<span class="id" title="keyword">Context</span> {<span class="id" title="var">BaseTypes</span> : <span class="id" title="var">ChainBase</span>}.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">N_scope</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab129"></a><h2 class="section">Convert N to amount</h2>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">N_to_amount</span> : <span class="id" title="var">N</span> -&gt; <span class="id" title="var">Amount</span> := <span class="id" title="var">Z.of_N</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab130"></a><h2 class="section">Sends XTZ's to a specific address from the contract address</h2>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">transfer_xtz</span> (<span class="id" title="var">addr</span>: <span class="id" title="var">Address</span>) (<span class="id" title="var">value</span>: <span class="id" title="var">N</span>) : <span class="id" title="var">option</span> <span class="id" title="var">ActionBody</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">_</span> &lt;- <span class="id" title="var">throwIf</span> (<span class="id" title="var">address_is_contract</span> <span class="id" title="var">addr</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="var">act_transfer</span> <span class="id" title="var">addr</span> (<span class="id" title="var">N_to_amount</span> <span class="id" title="var">value</span>)).<br/>

<br/>
</div>

<div class="doc">
<a name="lab131"></a><h2 class="section">Withdraw an amount of XTZ</h2>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">withdraw_xtz</span> (<span class="id" title="var">ctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">a</span> : <span class="id" title="var">option</span> <span class="id" title="var">N</span>) (<span class="id" title="var">s</span> : <span class="id" title="var">XTZLedger</span>) : <span class="id" title="var">option</span> (<span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span> * <span class="id" title="var">XTZLedger</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">available</span> := <span class="id" title="var">xtz_balance</span> <span class="id" title="var">s</span> <span class="id" title="var">ctx</span>.(<span class="id" title="var">ctx_from</span>)  <span class="id" title="tactic">in</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">value_opt</span> := <span class="id" title="keyword">match</span> <span class="id" title="var">a</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">v</span> =&gt; <span class="id" title="keyword">if</span> <span class="id" title="var">available</span> &lt;? <span class="id" title="var">v</span> <span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; <span class="id" title="var">Some</span> <span class="id" title="var">available</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">value</span> &lt;- <span class="id" title="var">value_opt</span> ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">available</span> =? 0 <span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> ([], <span class="id" title="var">s</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">op</span> &lt;- <span class="id" title="var">transfer_xtz</span> <span class="id" title="var">ctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="var">value</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_d</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">available</span> - <span class="id" title="var">value</span> =? 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">FMap.remove</span> <span class="id" title="var">ctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="var">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">FMap.update</span> <span class="id" title="var">ctx</span>.(<span class="id" title="var">ctx_from</span>) (<span class="id" title="var">Some</span> (<span class="id" title="var">available</span> - <span class="id" title="var">value</span>)) <span class="id" title="var">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">in</span> <span class="id" title="var">Some</span> ([<span class="id" title="var">op</span>], <span class="id" title="var">new_d</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab132"></a><h2 class="section">The return type for transfer generation</h2>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">tx_result</span> : <span class="id" title="keyword">Type</span> := <span class="id" title="var">list</span> <span class="id" title="var">transfer_destination</span> * <span class="id" title="var">TokenLedger</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab133"></a><h2 class="section">Generation of the FA2 transfer destinations</h2>
 This function also returns an updated ledger with all of the transfer destinations applied 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">generate_tx_destinations</span> (<span class="id" title="var">ctx</span>: <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">p</span> : <span class="id" title="var">WithdrawTokensParam</span>) (<span class="id" title="var">ledger</span>: <span class="id" title="var">TokenLedger</span>) : <span class="id" title="var">tx_result</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">fold_left</span> (<span class="id" title="keyword">fun</span> (<span class="id" title="var">acc</span> : <span class="id" title="var">tx_result</span>) (<span class="id" title="var">token_id</span> : <span class="id" title="var">N</span>) =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> (<span class="id" title="var">dsts</span>, <span class="id" title="var">s</span>) := <span class="id" title="var">acc</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">key</span> := (<span class="id" title="var">p</span>.(<span class="id" title="var">wtp_fa2_tokens</span>), <span class="id" title="var">token_id</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">available</span> := <span class="id" title="var">token_balance</span> <span class="id" title="var">ledger</span> <span class="id" title="var">ctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="var">key</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">available</span> =? 0 <span class="id" title="keyword">then</span> <span class="id" title="var">acc</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">let</span> <span class="id" title="var">new_dst</span> : <span class="id" title="var">transfer_destination</span> := {|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">to_</span> := <span class="id" title="var">ctx</span>.(<span class="id" title="var">ctx_from</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">dst_token_id</span> := <span class="id" title="var">token_id</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">amount</span> := <span class="id" title="var">available</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_ledger</span> := <span class="id" title="var">FMap.remove</span> (<span class="id" title="var">ctx</span>.(<span class="id" title="var">ctx_from</span>), <span class="id" title="var">key</span>) <span class="id" title="var">s</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id" title="var">new_dst</span> :: <span class="id" title="var">dsts</span>), <span class="id" title="var">new_ledger</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;) <span class="id" title="var">p</span>.(<span class="id" title="var">wtp_tokens</span>) ([], <span class="id" title="var">ledger</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab134"></a><h2 class="section">Calls the transfer function on the fa2 contract with a list of destinations</h2>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">transfer_operation</span> (<span class="id" title="var">fa2</span> <span class="id" title="var">from</span>: <span class="id" title="var">Address</span>) (<span class="id" title="var">dests</span> : <span class="id" title="var">list</span> <span class="id" title="var">transfer_destination</span>): <span class="id" title="var">ActionBody</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">tx</span> : <span class="id" title="var">transfer</span> := {|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">from_</span> := <span class="id" title="var">from</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">txs</span> := <span class="id" title="var">dests</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;|} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">act_call</span> <span class="id" title="var">fa2</span> (<span class="id" title="var">N_to_amount</span> 0) (<span class="id" title="var">serialize</span> <span class="id" title="var">tx</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab135"></a><h2 class="section">Genereate multiple token transfers and call the FA2 contract</h2>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">generate_tokens_transfer</span> (<span class="id" title="var">ctx</span>: <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">p</span> : <span class="id" title="var">WithdrawTokensParam</span>) (<span class="id" title="var">ledger</span>: <span class="id" title="var">TokenLedger</span>) : <span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span> * <span class="id" title="var">TokenLedger</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> (<span class="id" title="var">tx_dsts</span>, <span class="id" title="var">new_s</span>) := <span class="id" title="var">generate_tx_destinations</span> <span class="id" title="var">ctx</span> <span class="id" title="var">p</span> <span class="id" title="var">ledger</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">N_of_nat</span> (<span class="id" title="var">length</span> <span class="id" title="var">tx_dsts</span>) =? 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> ([], <span class="id" title="var">new_s</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">callback_op</span> := <span class="id" title="var">transfer_operation</span> <span class="id" title="var">ctx</span>.(<span class="id" title="var">ctx_contract_address</span>) <span class="id" title="var">p</span>.(<span class="id" title="var">wtp_fa2_tokens</span>) <span class="id" title="var">tx_dsts</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;([<span class="id" title="var">callback_op</span>], <span class="id" title="var">new_s</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab136"></a><h2 class="section">Generate a single token transfer and call the FA2 contract</h2>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">generate_token_transfer</span> (<span class="id" title="var">ctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">p</span> : <span class="id" title="var">WithdrawTokenParam</span>) (<span class="id" title="var">ledger</span>: <span class="id" title="var">TokenLedger</span>) : <span class="id" title="var">option</span> (<span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span> * <span class="id" title="var">TokenLedger</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">key</span> := (<span class="id" title="var">p</span>.(<span class="id" title="var">fa2_token</span>), <span class="id" title="var">p</span>.(<span class="id" title="var">wtp_token_id</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">available</span> := <span class="id" title="var">token_balance</span> <span class="id" title="var">ledger</span> <span class="id" title="var">ctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="var">key</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">n</span> &lt;- <span class="id" title="var">sub</span> <span class="id" title="var">available</span> <span class="id" title="var">p</span>.(<span class="id" title="var">wtp_amount</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">destination</span> : <span class="id" title="var">transfer_destination</span> := {|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">to_</span> := <span class="id" title="var">ctx</span>.(<span class="id" title="var">ctx_from</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">dst_token_id</span> := <span class="id" title="var">p</span>.(<span class="id" title="var">wtp_token_id</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">amount</span> := <span class="id" title="var">p</span>.(<span class="id" title="var">wtp_amount</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;|} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">callback_op</span> := <span class="id" title="var">transfer_operation</span> <span class="id" title="var">ctx</span>.(<span class="id" title="var">ctx_contract_address</span>) <span class="id" title="var">p</span>.(<span class="id" title="var">fa2_token</span>) [<span class="id" title="var">destination</span>] <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_ledger</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">n</span> =? 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">FMap.remove</span> (<span class="id" title="var">ctx</span>.(<span class="id" title="var">ctx_from</span>), <span class="id" title="var">key</span>) <span class="id" title="var">ledger</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">FMap.update</span> (<span class="id" title="var">ctx</span>.(<span class="id" title="var">ctx_from</span>), <span class="id" title="var">key</span>) (<span class="id" title="var">Some</span> <span class="id" title="var">n</span>) <span class="id" title="var">ledger</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> ([<span class="id" title="var">callback_op</span>], <span class="id" title="var">new_ledger</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab137"></a><h2 class="section">The Main entrypoint for the Fees</h2>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">fees_main</span> (<span class="id" title="var">ctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">s</span>: <span class="id" title="var">State</span>) (<span class="id" title="var">p</span>: <span class="id" title="var">WithdrawalEntrypoint</span>): <span class="id" title="var">option</span> <span class="id" title="var">ReturnType</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">p</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Withdraw_all_tokens</span> <span class="id" title="var">p</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> (<span class="id" title="var">ops</span>, <span class="id" title="var">new_b</span>) := <span class="id" title="var">generate_tokens_transfer</span> <span class="id" title="var">ctx</span> <span class="id" title="var">p</span> <span class="id" title="var">s</span>.(<span class="id" title="var">fees</span>).(<span class="id" title="var">fees_storage_tokens</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="var">s</span>&lt;|<span class="id" title="var">fees</span>:=<span class="id" title="var">s</span>.(<span class="id" title="var">fees</span>)&lt;|<span class="id" title="var">fees_storage_tokens</span>:=<span class="id" title="var">new_b</span>|&gt;|&gt;, <span class="id" title="var">ops</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Withdraw_all_xtz</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">res</span> &lt;- <span class="id" title="var">withdraw_xtz</span> <span class="id" title="var">ctx</span> <span class="id" title="var">None</span> <span class="id" title="var">s</span>.(<span class="id" title="var">fees</span>).(<span class="id" title="var">fees_storage_xtz</span>) ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="var">s</span>&lt;|<span class="id" title="var">fees</span>:=<span class="id" title="var">s</span>.(<span class="id" title="var">fees</span>)&lt;|<span class="id" title="var">fees_storage_xtz</span>:=<span class="id" title="var">snd</span> <span class="id" title="var">res</span>|&gt;|&gt;, <span class="id" title="var">fst</span> <span class="id" title="var">res</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Withdraw_token</span> <span class="id" title="var">p</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">res</span> &lt;- <span class="id" title="var">generate_token_transfer</span> <span class="id" title="var">ctx</span> <span class="id" title="var">p</span> <span class="id" title="var">s</span>.(<span class="id" title="var">fees</span>).(<span class="id" title="var">fees_storage_tokens</span>) ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="var">s</span>&lt;|<span class="id" title="var">fees</span>:=<span class="id" title="var">s</span>.(<span class="id" title="var">fees</span>)&lt;|<span class="id" title="var">fees_storage_tokens</span>:=<span class="id" title="var">snd</span> <span class="id" title="var">res</span>|&gt;|&gt;, <span class="id" title="var">fst</span> <span class="id" title="var">res</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Withdraw_xtz</span> <span class="id" title="var">a</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">res</span> &lt;- <span class="id" title="var">withdraw_xtz</span> <span class="id" title="var">ctx</span> (<span class="id" title="var">Some</span> <span class="id" title="var">a</span>) <span class="id" title="var">s</span>.(<span class="id" title="var">fees</span>).(<span class="id" title="var">fees_storage_xtz</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="var">s</span>&lt;|<span class="id" title="var">fees</span>:=<span class="id" title="var">s</span>.(<span class="id" title="var">fees</span>)&lt;|<span class="id" title="var">fees_storage_xtz</span>:=<span class="id" title="var">snd</span> <span class="id" title="var">res</span>|&gt;|&gt;, <span class="id" title="var">fst</span> <span class="id" title="var">res</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">Fees</span>.<br/>
</div>
</div>

<div id="footer">
<hr/><a href="index.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>