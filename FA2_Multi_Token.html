<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<title>FA2_Multi_Token</title>
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Library FA2_Multi_Token</h1>

<div class="code">
</div>

<div class="doc">
<a name="lab87"></a><h1 class="section">FA2 Multi Token</h1>
 This file contains the implementation of the file: 
https://github.com/bender-labs/wrap-tz-contracts/blob/1655949e61b05a1c25cc00dcb8c1da9d91799f31/ligo/fa2/multi_asset/fa2_multi_token.mligo
It contains methods for changing the balances of token accounts holding wrapped assets, mainly through transfers.

</div>
<div class="code">
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">ZArith</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Blockchain</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ConCert.Examples</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">FA2Interface</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">FA2Interface_Wrap</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Fees_Lib</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">FA2Types</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Containers</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Monads</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">FA2_Operator_Lib</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">List</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Serializable</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">RecordUpdate</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">ContractCommon</span>.<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">ListNotations</span>.<br/>

<br/>
<span class="id" title="keyword">Section</span> <span class="id" title="var">FA2_Multi_Token</span>.<br/>

<br/>
<span class="id" title="keyword">Context</span> {<span class="id" title="var">BaseTypes</span> : <span class="id" title="var">ChainBase</span>}.<br/>

<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">N_scope</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab88"></a><h2 class="section">Get Balance Amount</h2>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">get_balance_amt</span> (<span class="id" title="var">key</span> : (<span class="id" title="var">Address</span> * <span class="id" title="var">N</span>)) (<span class="id" title="var">ledger</span> : <span class="id" title="var">Ledger</span>) : <span class="id" title="var">N</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">bal_opt</span> := <span class="id" title="var">FMap.find</span> <span class="id" title="var">key</span> <span class="id" title="var">ledger</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">bal_opt</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">b</span> =&gt; <span class="id" title="var">b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
<a name="lab89"></a><h2 class="section">Increment Balance</h2>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">inc_balance</span> (<span class="id" title="var">owner</span>: <span class="id" title="var">Address</span>) (<span class="id" title="var">token_id</span> : <span class="id" title="var">token_id</span>) (<span class="id" title="var">amt</span> : <span class="id" title="var">N</span>) (<span class="id" title="var">ledger</span> : <span class="id" title="var">Ledger</span>) : <span class="id" title="var">Ledger</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">key</span> := (<span class="id" title="var">owner</span>, <span class="id" title="var">token_id</span>) <span class="id" title="tactic">in</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">bal</span> := <span class="id" title="var">get_balance_amt</span> <span class="id" title="var">key</span> <span class="id" title="var">ledger</span> <span class="id" title="tactic">in</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">updated_bal</span> := <span class="id" title="var">bal</span> + <span class="id" title="var">amt</span> <span class="id" title="tactic">in</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">updated_bal</span> =? 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">FMap.remove</span> <span class="id" title="var">key</span> <span class="id" title="var">ledger</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">FMap.update</span> <span class="id" title="var">key</span> (<span class="id" title="var">Some</span> <span class="id" title="var">updated_bal</span>) <span class="id" title="var">ledger</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab90"></a><h2 class="section">Decrement Balance</h2>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">dec_balance</span> (<span class="id" title="var">owner</span>: <span class="id" title="var">Address</span>) (<span class="id" title="var">token_id</span> : <span class="id" title="var">token_id</span>) (<span class="id" title="var">amt</span> : <span class="id" title="var">N</span>) (<span class="id" title="var">ledger</span> : <span class="id" title="var">Ledger</span>) : <span class="id" title="var">option</span> <span class="id" title="var">Ledger</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">key</span> := (<span class="id" title="var">owner</span>, <span class="id" title="var">token_id</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">bal</span> := <span class="id" title="var">get_balance_amt</span> <span class="id" title="var">key</span> <span class="id" title="var">ledger</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">new_bal</span> &lt;- <span class="id" title="var">sub</span> <span class="id" title="var">bal</span>  <span class="id" title="var">amt</span> ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="keyword">if</span> <span class="id" title="var">new_bal</span> =? 0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">FMap.remove</span> <span class="id" title="var">key</span> <span class="id" title="var">ledger</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">FMap.update</span> <span class="id" title="var">key</span> (<span class="id" title="var">Some</span> <span class="id" title="var">new_bal</span>) <span class="id" title="var">ledger</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab91"></a><h2 class="section">Transfer</h2>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">transfer</span> (<span class="id" title="var">ctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">transfers</span> : <span class="id" title="var">list</span> <span class="id" title="var">transfer</span>) (<span class="id" title="var">validate_op</span> : <span class="id" title="var">OperatorValidator</span>) (<span class="id" title="var">storage</span> : <span class="id" title="var">MultiTokenStorage</span>) : <span class="id" title="var">option</span> <span class="id" title="var">Ledger</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">make_transfer</span> := <span class="id" title="keyword">fun</span> (<span class="id" title="var">l_opt</span> : <span class="id" title="var">option</span> <span class="id" title="var">Ledger</span>) (<span class="id" title="var">tx</span> : <span class="id" title="var">transfer</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">l</span> &lt;- <span class="id" title="var">l_opt</span> ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">fold_left</span> (<span class="id" title="keyword">fun</span> (<span class="id" title="var">ll_opt</span> : <span class="id" title="var">option</span> <span class="id" title="var">Ledger</span>) (<span class="id" title="var">dst</span> : <span class="id" title="var">transfer_destination</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">ll</span> &lt;- <span class="id" title="var">ll_opt</span> ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">_</span> &lt;- <span class="id" title="var">FMap.find</span> <span class="id" title="var">dst</span>.(<span class="id" title="var">dst_token_id</span>) <span class="id" title="var">storage</span>.(<span class="id" title="var">mts_token_metadata</span>) ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">_</span> &lt;- <span class="id" title="var">validate_op</span> <span class="id" title="var">tx</span>.(<span class="id" title="var">from_</span>) <span class="id" title="var">ctx</span>.(<span class="id" title="var">ctx_from</span>) <span class="id" title="var">dst</span>.(<span class="id" title="var">dst_token_id</span>) <span class="id" title="var">storage</span>.(<span class="id" title="var">operators</span>) ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">lll</span> &lt;- <span class="id" title="var">dec_balance</span> <span class="id" title="var">tx</span>.(<span class="id" title="var">from_</span>) <span class="id" title="var">dst</span>.(<span class="id" title="var">dst_token_id</span>) <span class="id" title="var">dst</span>.(<span class="id" title="var">amount</span>) <span class="id" title="var">ll</span> ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="var">inc_balance</span> <span class="id" title="var">dst</span>.(<span class="id" title="var">to_</span>) <span class="id" title="var">dst</span>.(<span class="id" title="var">dst_token_id</span>) <span class="id" title="var">dst</span>.(<span class="id" title="var">amount</span>) <span class="id" title="var">lll</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;) <span class="id" title="var">tx</span>.(<span class="id" title="var">txs</span>) (<span class="id" title="var">Some</span> <span class="id" title="var">l</span>)<br/>
&nbsp;&nbsp;<span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="var">fold_left</span> <span class="id" title="var">make_transfer</span> <span class="id" title="var">transfers</span> (<span class="id" title="var">Some</span> <span class="id" title="var">storage</span>.(<span class="id" title="var">ledger</span>)).<br/>

<br/>
</div>

<div class="doc">
<a name="lab92"></a><h2 class="section">Get Balance</h2>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">get_balance</span> (<span class="id" title="var">p</span> : <span class="id" title="var">balance_of_param</span>) (<span class="id" title="var">ledger</span> : <span class="id" title="var">Ledger</span>) (<span class="id" title="var">tokens</span> : <span class="id" title="var">TokenMetaDataStorage</span>) : <span class="id" title="var">option</span> <span class="id" title="var">ActionBody</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">to_balance</span> := <span class="id" title="keyword">fun</span> (<span class="id" title="var">acc_opt</span> : <span class="id" title="var">option</span> (<span class="id" title="var">list</span> <span class="id" title="var">balance_of_response</span>)) (<span class="id" title="var">r</span> : <span class="id" title="var">balance_of_request</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">acc</span> &lt;- <span class="id" title="var">acc_opt</span> ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">_</span> &lt;- <span class="id" title="var">FMap.find</span> <span class="id" title="var">r</span>.(<span class="id" title="var">bal_req_token_id</span>) <span class="id" title="var">tokens</span> ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">key</span> := (<span class="id" title="var">r</span>.(<span class="id" title="var">owner</span>), <span class="id" title="var">r</span>.(<span class="id" title="var">bal_req_token_id</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">bal</span> := <span class="id" title="var">get_balance_amt</span> <span class="id" title="var">key</span> <span class="id" title="var">ledger</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">response</span> := {|<span class="id" title="var">request</span> := <span class="id" title="var">r</span>; <span class="id" title="var">balance</span> := <span class="id" title="var">bal</span>|} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="var">response</span> :: <span class="id" title="var">acc</span>)<br/>
&nbsp;&nbsp;<span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">responses_opt</span> := <span class="id" title="var">fold_left</span> <span class="id" title="var">to_balance</span> <span class="id" title="var">p</span>.(<span class="id" title="var">bal_requests</span>) (<span class="id" title="var">Some</span> []) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">responses</span> &lt;- <span class="id" title="var">responses_opt</span> ;<br/>
&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="var">act_call</span> <span class="id" title="var">p</span>.(<span class="id" title="var">bal_callback</span>) 0 (<span class="id" title="var">serialize</span> <span class="id" title="var">responses</span>)).<br/>

<br/>
</div>

<div class="doc">
<a name="lab93"></a><h2 class="section">Main method of Multi Token</h2>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">fa2_main</span> (<span class="id" title="var">ctx</span> : <span class="id" title="var">ContractCallContext</span>) (<span class="id" title="var">param</span> : <span class="id" title="var">FA2EntryPoints</span>) (<span class="id" title="var">storage</span> : <span class="id" title="var">MultiTokenStorage</span>) : <span class="id" title="var">option</span> (<span class="id" title="var">MultiTokenStorage</span> * (<span class="id" title="var">list</span> <span class="id" title="var">ActionBody</span>)) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">param</span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <span class="id" title="var">FA2_Transfer</span> <span class="id" title="var">txs</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">new_ledger</span> &lt;- <span class="id" title="var">transfer</span> <span class="id" title="var">ctx</span> <span class="id" title="var">txs</span> <span class="id" title="var">default_operator_validator</span> <span class="id" title="var">storage</span> ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_storage</span> := <span class="id" title="var">storage</span>&lt;|<span class="id" title="var">ledger</span> := <span class="id" title="var">new_ledger</span>|&gt; <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="var">new_storage</span>, [])<br/>
&nbsp;&nbsp;| <span class="id" title="var">Balance_of</span> <span class="id" title="var">p</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">op</span> &lt;- <span class="id" title="var">get_balance</span> <span class="id" title="var">p</span> <span class="id" title="var">storage</span>.(<span class="id" title="var">ledger</span>) <span class="id" title="var">storage</span>.(<span class="id" title="var">mts_token_metadata</span>) ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="var">storage</span>, [<span class="id" title="var">op</span>])<br/>
&nbsp;&nbsp;| <span class="id" title="var">Update_operators</span> <span class="id" title="var">updates</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> <span class="id" title="var">new_ops</span> &lt;- <span class="id" title="var">fa2_update_operators</span> <span class="id" title="var">ctx</span> <span class="id" title="var">updates</span> <span class="id" title="var">storage</span>.(<span class="id" title="var">operators</span>) ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> (<span class="id" title="var">storage</span>, [])<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">FA2_Multi_Token</span>.<br/>
</div>
</div>

<div id="footer">
<hr/><a href="index.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>